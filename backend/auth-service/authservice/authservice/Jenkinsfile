pipeline {
    agent any

    parameters {
        string(name: 'USER_EMAIL', defaultValue: 'user@gmail.com', description: 'Enter email for pipeline alerts')
    }

    environment {
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-creds')
        SONAR_AUTH_TOKEN = credentials('sonar-token')
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/RamyaAgali/smarttrip-ai-travel-planner'
            }
        }

        stage('Run Tests') {
            steps {
                dir('backend/auth-service/authservice/authservice') {
                    bat 'mvn test'
                }
            }
        }

        stage('Publish Coverage') {
            steps {
                jacoco(execPattern: '**/jacoco.exec', classPattern: '**/classes', sourcePattern: '**/src/main/java')
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('local-sonar') {
                    dir('backend/auth-service/authservice/authservice') {
                        bat """
                            mvn sonar:sonar ^
                            -Dsonar.projectKey=auth-service ^
                            -Dsonar.host.url=http://localhost:9000 ^
                            -Dsonar.token=%SONAR_AUTH_TOKEN%
                        """
                    }
                }
            }
        }
    }
    //     stage('Build Docker Image') {
    //         steps {
    //             dir('backend/auth-service/authservice/authservice') {
    //                 bat 'docker build -t auth-service-image:latest .'
    //             }
    //         }
    //     }

    //     stage('Stop Old Container') {
    //         steps {
    //             bat """
    //                 docker ps -a -q -f name=auth-service > cid.txt
    //                 set CID=
    //                 for /f "tokens=*" %%i in (cid.txt) do set CID=%%i
    //                 if NOT "%CID%"=="" docker rm -f %CID%
    //             """
    //         }
    //     }

    //     stage('Run New Container') {
    //         steps {
    //             bat """
    //                 docker run -d ^
    //                     --name auth-service ^
    //                     -p 8081:8081 ^
    //                     auth-service-image:latest
    //             """
    //         }
    //     }
    // }

     post {
        success {
            emailext(
                to: "${params.USER_EMAIL}",
                subject: "SUCCESS: ${env.JOB_NAME}",
                body: "Pipeline succeeded.\n\nBuild URL: ${env.BUILD_URL}"
            )
        }

        failure {
            emailext(
                to: "${params.USER_EMAIL}",
                subject: "FAILED: ${env.JOB_NAME}",
                body: "Pipeline failed.\n\nCheck logs: ${env.BUILD_URL}"
            )
        }
    }
}